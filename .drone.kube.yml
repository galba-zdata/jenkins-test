kind: pipeline
type: kubernetes
name: default

steps:    
- name: build
  image: plugins/docker
  settings:
    dockerfile: Dockerfile
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    registry: harbor.internal.ddm.zdatainc.io
    repo: harbor.internal.ddm.zdatainc.io/library/cicd-demo
  
- name: test
  image: harbor.internal.ddm.zdatainc.io/library/cicd-demo
  commands:
    - mvn test

- name: publish
  image: plugins/docker
  settings:
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    registry: harbor.internal.ddm.zdatainc.io
    repo: harbor.internal.ddm.zdatainc.io/library/cicd-demo
    purgue: true
    tags: ${DRONE_COMMIT}

- name: deploy_production
  image: pelotech/drone-helm3
  settings:
    helm_command: upgrade
    chart: ./charts
    release: test
    skip_tls_verify: true
    values: Tag=${DRONE_COMMIT}
    namespace: drone
    wait_for_upgrade: true
    cleanup_failed_upgrade: true
    api_server:
      from_secret: kubernetes_stage_server
    kubernetes_token:
      from_secret: kubernetes_token
